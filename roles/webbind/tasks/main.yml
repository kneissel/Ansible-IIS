---
- name: Check if self-signed ssl certificat exist
  win_shell: dir cert:\LocalMachine\My -Recurse | where {$_.subject -eq "cn={{webbindheader}}"} | Select-Object -ExpandProperty Thumbprint 
  register: wingetcert_result
  when: webbindprotocol == "https"

- debug:
  msg: "{{wingetcert_result.stdout_lines}}"

- name: Create self-signed ssl certificat if needed
  win_shell: New-SelfSignedCertificate -DnsName {{webbindheader}} -CertStoreLocation cert:\LocalMachine\My | Select-Object -ExpandProperty Thumbprint 
  register: wincreatecert_result
  when: webbindprotocol == "https" and not wingetcert_result.stdout_lines

- name: Configure Bindings
  block:
  - name: When site ip and ports equal bind ip and port
    win_iis_webbinding:
      name: "{{websitename}}"
      protocol: 'http'
      port: "{{websiteport}}"
      ip: "{{websiteip}}"
      state: 'absent'
    when: (websiteip and webbindip == websiteip and websiteport and webbindport == websiteport) or (websiteip and webbindip == "*" and websiteport and webbindport == websiteport)
  - name: With existing auto certificate
    win_iis_webbinding:
      name: "{{websitename}}"
      protocol: "{{webbindprotocol}}"
      port: "{{webbindport}}"
      ip: "{{webbindip}}"
      host_header: "{{webbindheader}}"
      certificate_hash: "{{wingetcert_result.stdout_lines}}"
      ssl_flags:  "{{webbindflag}}"
      state: "{{webbindstate}}"
    when: wingetcert_result.stdout_lines

  - name: With new auto certificate
    win_iis_webbinding:
      name: "{{websitename}}"
      protocol: "{{webbindprotocol}}"
      port: "{{webbindport}}"
      ip: "{{webbindip}}"
      host_header: "{{webbindheader}}"
      certificate_hash: "{{wincreatecert_result.stdout_lines}}"
      ssl_flags:  "{{webbindflag}}"
      state: "{{webbindstate}}"
    when: not wingetcert_result.stdout_lines
